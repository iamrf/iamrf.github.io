---
layout: post
title:  "جنگوی زنجیر گسسته - تنظیمات پیکربندی"
date:   2019-12-02 09:00:00 +0400
categories: ['آموزش جنگو', ]
tags: ['آموزش جنگو', 'جنگو زنجیر گسسته', 'Django', 'پایتون', 'تنظیمات', 'settings',]
thumbnail: 'files/img/django-logo-negative.png'
published: true
---
در قسمت اول سری آموزشی جنگوی زنجیر شکسته میریم سراغ تنظیمات. جایی که همه تنظیمات پیکربندی نصب و اجرای برنامه شما را در خودش نگهداری میکنه.
فایل تنظیمات جنگو یا همون <i>settings.py</i> یک ماژول پایتون است ([اسناد رسمی پایتون-ماژول ها][python-module]) ، پس شما باید از دستورات پایتون برای اعمال تنظیمات استفاده کنید.

در اینجا قسمتی از فایل تنظیمات را میبینیم:

{% highlight python %}
# SECURITY WARNING: don't run with debug turned on in production!
DEBUG = True
ALLOWED_HOSTS = []

# Application definition
INSTALLED_APPS = [
    'django.contrib.admin',
    'django.contrib.auth',
    'django.contrib.contenttypes',
    'django.contrib.sessions',
    'django.contrib.messages',
    'django.contrib.staticfiles',
]
{% endhighlight %}

خب اینجا تو خط اول به ما یه هشدار امنیتی میده که حالت دیباگ را در مرحله اجرای برنامه بر روی سرور غیرفعال کنیم، چرا؟ واضحه چون اگه خاصیت دیباگ فعال باشه، هرجایی که مشکلی پیش بیاد خطا میده و با توجه به اون خطا شما خیلی راحت میتونید مشکل را برطرف کنید پس اصلا منطقی نیست که بازدید کننده ها بدون هیچ دردسری باگ های برنامه شما رو ببینن!!!

از طرف دیگه زمانی بهتون اجازه غیر فعال کردن حالت دیباگ رو میده که آدرس برنامتونو در قسمت ```ALLOWED_HOSTS``` مشخص کنید. مثلا اینطوری:

{% highlight python %}
DEBUG = False
ALLOWED_HOSTS = ['www.example.com']     # دامنه شما
{% endhighlight %}

<br>
<blockquote class="grey lighten-3">
<i class="fa fa-check-circle"></i>&nbsp; 
در همه حال DRY را رعایت کنید !!!
<br>
اگر تجربه کار با جنگو را داشته باشید حد اقل یک بار کلمه DRY را شنیدید. اگر هم نه الان بهتون میگم.
</blockquote>
<br>
<h5>DRY چیست ؟  </h5>
DRY مخفف عبارت Don't Repeat Yourself 
است . 
مفهومی که میخواد به ما بگه از کار های تکراری دوری کنید . DRY بهمون میگه تا جایی که ممکنه از اختراع دوباره چرخ اجتناب کنید.
واقعا نیازی به نوشتن کدهای تکراری وجود نداره اگر خوب و بهینه کد ها رو بنویسیم .
<br><br>


<blockquote class="grey lighten-3">

<h5> قانون طلایی در طراحی برنامه های جنگو </h5>

به قول جیمز بنت، توسعه دهنده ی هسته و همینطور مدیر انتشار (Release manager) جنگو ، 
<b>
راز طراحی و توسعه ی هنرمندانه ی یک برنامه ی جنگو ، پیروی از فلسفه ی یونیکس است .
</b>
<br>
فلسفه یونیکس مجموعه‌ای از هنجارهای فرهنگی و رویکردهای فلسفی برای توسعه نرم‌افزارهای کوچک اما تواناست که بر اساس تجربیات توسعه‌دهندگان برجسته سیستم‌عامل یونیکس شکل گرفته‌است.
<b>
فلسفه یونیکس بر روی ساختاری کوچک، ساده، واضح، پیمانه‌ای و قابل گسترش تأکید دارد
</b>
 که به غیر از نویسندگان اصلی و اولیه کد، توسعه‌دهندگان دیگر هم بتوانند آن را به سادگی نگه‌داری کنند و برای اهداف مختلف از آن استفاده کنند. 
<br><br>
داگلاس مک ایلروی ، یکی از توسعه دهندگان یونیکس ، فلسفه ی یونیکس را در این سه جمله تعریف میکند :
<br>
Write programs that do one thing and do it well
<br>
<b>
برنامه‌هایی بنویسید که تنها یک کار را انجام دهند، اما آن کار را به خوبی انجام دهند.
</b>
<br>
Write programs to work together
<br>
<b>
برنامه‌هایی بنویسید که بتوانند با یکدیگر کار کنند. 
</b>
<br>
Write programs to handle text streams, because that is a universal interface
<br>
<b>
برنامه‌هایی بنویسید که بتوانند جریان‌های متنی را مدیریت کنند، چرا که آنها یک رابط جامع و کامل هستند.
</b>
</blockquote>


<br>
<h5>ریشه و نحوه کار تنظیمات پیکربندی در پروژه جنگو</h5>
در فایل تنظیمات اولیه همه متغیر هایی که برای پیکر بندی اولیه نیاز هست قرار دارن و جدا از اونا ما میتونیم تنظیمات دیگری رو هم اضافه کنیم که میشه گفت همشون متغیر های پایتونی اند. هر متغیر، شامل یک مقدار پیشفرض مشخصی است که این پیشفرض ها در ماژولی در مسیر <i>django/conf/global_settings.py</i> تعیین شده اند.

تنظیمات پیکربندی با ران شدن سرور، کامپایل میشن و برای اعمال تغییرات، سرور باید ری استارت شه پس نباید در حالت اجرا تنظیمات را تغییر بدیم (بهتره در محیط توسعه تغییرات را اعمال کنیم)

<br>
<h5>الگوریتم جنگو برای کامپایل تنظیمات پیکربندی</h5>
جنگو کامپایل تنظیمات پیکربندی را به ترتیب زیر انجام میده :
<blockquote class="grey lighten-3">
1 -  بارگزاری تنظیمات پیکر بندی از ماژول <i>global_settings.py</i>
<br>
2 - بارگزاری تنظیمات پیکربندی از ماژول <i>settings.py</i> و جایگزین کردن تنظیمات <i>settings.py</i> به جای تنظیماتی که در مرحله قبل توسط <i>global_settings.py</i> بارگزاری شدند.
</blockquote>

<br>
<h5>مشاهده diff تنظیمات</h5>
برای مشاهده تنظیماتی که نسبت به تنظیمات پیشفرض تغییر کردن میتونیم از دستور ```python manage.py diffsettings``` استفاده کنیم.

[diff چیست؟][diff-wiki]

<br>
<h5> استفاده از تنظیمات پیکربندی در جاهای دیگر</h5>
برای استفاده از تنظیمات پیکربندی در کدهای پایتونی خودمون، باید شئ <b>settings</b> را از ماژول <i>django.conf</i> فراخوانی کنیم :

{% highlight python %}
from django.conf import settings

if settings.DEBUG:  # مثلا اگر حالت دیباگ فعال بود
    # فلان کارو انجام بده
{% endhighlight %}

نکته ای که باید حواسمون بهش باشه اینه که <i>django.conf.settings</i> یک ماژول نیست بلکه تنها یک شئ است، پس نمیتونیم مثلا ویژگی ```DEBUG``` در مثال قبل را در کد پایتونی خودمون ایمپورت کنیم :

{% highlight python %}
from django.conf.settings import DEBUG  # کار نخواهد کرد

Traceback (most recent call last):
  File "<console>", line 1, in <module>
ModuleNotFoundError: No module named 'django.conf.settings'

{% endhighlight %}

نکته دیگه اینکه هرگز نباید متغیر های پیکربندی را از <i>global_settings</i> و یا فایل تنظیمات خودمون <i>settings.py</i> به کد پایتونی ایمپورت کنیم چون باعث دوگانگی و اختلال در برنامه میشه. پس برای این کار تنها شئ 
<i>django.conf.settings</i>
 را در کد پایتونی خود فراخوانی کرده تا از این طریق به ویژگی های 
 <i>global_settings</i> و <i>settings</i>
  دسترسی داشته باشیم .

<br>
<h5>تغییر تنظیمات پیکربندی در زمان اجرا</h5>
هرگز نباید تنظیمات پیکربندی را در زمان اجرا و در سایر کدهای پایتونی تغییر بدیم.مثلا تغییر تنظیمات پیکربندی از طریق <b>view</b> ها کار درستی نیست! چرا؟ دلیلشو قبلا گفتیم و الان میدونیم که اینکار چقدر میتونه گرون تموم شه برامون.

{% highlight python %}
from django.conf import settings

settings.DEBUG = True   # هرگز این کارو نکنید!!!
{% endhighlight %}

تکرار میکنم تنظیمات پیکربندی را فقط باید از طریق <b>settings.py</b> ویرایش کنیم.

<br>
<h5>متغیر های موجود برای تنظیمات</h5>
اسناد رسمیِ جنگو، در 
[این صفحه][django-ref-settings]
به بررسی کامل همه متغیر های موجود برای تنظیمات و مقدار پیش فرض آنها پرداخته است.
البته امیدوارم در آینده نزدیک در یکی از قسمت های همین سری آموزشی بتونیم این صفحه را به طور کامل بررسی کنیم .

<br>
<h5> کنترل نسخه </h5>
[کنترل نسخه (Version Control System) چیست ؟][vcs-wiki]

استفاده از ابزار کنترل نسخه طی مراحل طراحی ، توسعه و استقرار پروژه میتونه خیلی به ما کمک کنه تا همه تغییرات را تحت نظر داشته باشیم و در مواقع نیاز ، این تغییرات را کنترل کنیم .

در زمان اجرای برنامه در سرور (در حالت بهره برداری از پروژه) استفاده از کنترل نسخه بسیار حیاتی است. چرا؟؟؟
 چون ما میخواهیم همه جزئیات از جمله زمان، تاریخ، تغییرات تنظیمات پیکربندی، تغییر نام فایل ها و هر تغییر کوچکی توسط ابزار کنترل نسخه (مثلا گیت Git) ردیابی شوند تا هم از تغییرات اطلاع داشته باشیم و هم بتونیم در مواقع لزوم، فایل های تغییر کرده را به حالت قبلی برگردانیم .

پس میبینیم که ردیابی تغییرات در پروژه مخصوصا در وضعیت بهره برداری (Production یا Deploy) چقدر مهمه و نادیده گرفتن این موضوع چقدر میتونه کار رو برامون سخت کنه.

[کتاب آموزش گیت - Pro Git book - نسخه فارسی][git-tutorial]

<br>
<h5> امنیت </h5>
خب رسیدیم به قسمت جذاب ماجرا . امنیت‌ !!!

تا اینجا با چند نکته برای بالا بردن امنیت برنامه آشنا شدیم ، حالا باید کمی سخت گیرانه تر برخورد کنیم .

<br>
<i class="fa fa-arrow-left"></i> &nbsp; 
<b>
از تنظیمات محلی (Local) بدون ردیابی نسخه خودداری کنید 
</b>

ما به عنوان توسعه دهنده ی برنامه ، به تنظیمات مخصوص خودمون در محیط توسعه نیاز داریم . تنظیماتی مانند فعال سازی ابزار دیباگ که در محیط توسعه به آن نیاز داریم اما در وضعیت Staging و یا بهره برداری باید آن را غیر فعال کنیم 
( و یا اصلا در این وضعیت آن ها را نصب نکنیم)

همچنین برای امنیت بیشتر ، فکر خوبیه که یک سری تنظیمات خاص را از مخازن (Repositories) عمومی و حتی خصوصی دور نگه داریم .
اولین نمونه ای که از این تنظیمات به ذهن میاد ، کلید خصوصی (SECRET_KEY) است .
همچنین سایر کلید ها مانند کلید های API ها و ... و هرگونه متغیر های از جنس Password نیز نباید در مخازن وجود داشته باشند .

<blockquote class="grey lighten-3">
<b> راز های خود را در یک جای امن نگه دارید </b>
<br>
SECRET_KEY در واقع یک کلید خصوصی (Private Key) است که در سیستم رمز نگاری جنگو استفاده میشود .
وقتی صحبت از کلید خصوصی شماست یعنی این کلید فقط مختص شما میشه پس باید یکتا (Unique) باشه .
پس نباید توسط ابزار کنترل نسخه ردیابی شه ، اگر SECRET_KEY شما توسط گیت ردیابی شه پس دیگران میتونن این کلید خصوصی شمارو داشته باشن که این اصلا جالب نیست ، فکر نکنم کسی دوست داشته باشه کلید خونشو یکی دیگه هم داشته باشه .
<br>
همچنین این خطر برای بقیه دیتا های حساس شما هم وجود داره ، مثلا رمز عبور دیتابیس ، کلید های AWS ، توکن های OAuth و ... هم باید در یک جای امن نگه داری شوند .
</blockquote>

[کلید عمومی و کلید خصوصی چیست ؟][public-key]

[سیستم رمز نگاری جنگو][django-signing]

یک راه حل ساده این کار ساخت یک ماژول <i> local_settings.py </i> به صورت محلی برای هر سرور و یا محیط توسعه است که توسط ابزار کنترل نسخه ردیابی نشوند .
در این حالت توسعه دهنده ها میتونن تغییرات خودشونو در تنظیمات پیکربندی اعمال کنند بدون اینکه این تغییرات توسط ابزار کنترل نسخه ردیابی شوند .
همچنین سرورهایی که در وضعیت Staging یا Deployment هستند هم تنظیمات پیکربندیِ محلیِ مختص خودشان را دارند که این تنظیمات توسط ابزار کنترل نسخه ردیابی نشده و به این ترتیب در مخازن عمومی و خصوصی هم وجود نخواهند داشت .

خب ، آیا با این روش به مشکل خواهیم خورد ؟ معایب این روش چیست ؟

− در این وضعیت ماژول تنظیمات پیکربندی محلی ( <i> local_settings.py </i> ) در همه محیط ها از جمله محیط توسعه ، Staging و بهره برداری ( Production ) توسط ابزار کنترل نسخه ردیابی نمیشوند .

− چه حسی پیدا میکنید وقتی بعد از ساعتها کلنجار رفتن با یک باگ در محیط توسعه ( Local ) ، متوجه شوید مشکل فقط از قسمتی از تنظیمات در محیط بهره برداری ( Production ) است ؟

− چقدر ناامید میشوید وقتی متوجه شوید آن باگ را که در محیط محلی پیدا کرده ، آن را برطرف کرده و این تغییرات را در نسخه بهره برداری پیاده سازی کرده اید ،  واقعاً ناشی از شخصی سازی هایی است که در ماژول تنظیمات محلی خود (<i> local_settings.py </i>) انجام داده اید و اکنون سایت را با مشکل مواجه کرده است ؟

− در این حالت همه ماژول (<i> local_settings.py </i> ) را در محیط های مختلف کپی میکنند که این عمل ، فلسفه DRY را نقض نمیکند 
( چون در هر محیط فقط یک ماژول <i> local_settings.py </i> داریم ) ، اما در مقیاس بزرگ چطور ؟

همانطور که دیدیم این روش میتونه مارو به دردسر بندازه ، پس باید یک روش جدید را امتحان کنیم .

بیایید تنظیمات پیکربندی را به چند تکه تقسیم کنیم ، تکه هایی متناسب با محیط اجرا
(<b> Development , Staging , Test , Production </b>)
 که همشون از یک ماژول اصلی که توسط ابزار کنترل نسخه ردیابی میشود ، ارث بری داشته باشند .
همچنین باید مطمئن شویم که رازهایمان ( کلید ها ، توکن ها ، رمز عبور ها و ... ) بصورت راز باقی بمانند .

<br>
<i class="fa fa-arrow-left"></i> &nbsp;
<b>
تنظیمات پیکربندی چندگانه
</b>
<br>
به جای ماژول <i> settings.py </i> میتوانیم یک دایرکتوری <i> settings </i> داشته باشیم که همه ماژول های تنظیمات را درون خود نگه میدارد . به مثال زیر دقت کنید :

{% highlight shell %}
settings/
    __init__.py
    base.py
    local.py
    staging.py
    test.py
    production.py
{% endhighlight %}

<blockquote class="grey lighten-3">
فایل __init__ چیست ؟
<br>
یک فایل خالی با پسوند py است که اگر در یک دایرکتوری وجود داشته باشد ، پایتون از آن دایرکتوری به عنوان یک دایرکتوری بسته نرم افزاری ( Python package directory ) استفاده میکند .
<br>
به بیان ساده تر ، اگر این فایل داخل دایرکتوری ما وجود نداشته باشد ، نمیتوانیم این ماژول ها را در پایتون بارگزاری ( import ) کنیم . 
</blockquote>




<i class="fa fa-chevron-left"></i> &nbsp;
<b>
base.py
</b>

همان ماژول اصلی و مشترک بین همه تنظیمات است که تنظیمات مشترک را در خود نگه میدارد و سایر ماژول ها از این ماژول ارث بری میکنند .

<i class="fa fa-chevron-left"></i> &nbsp;
<b>
local.py
</b>

ماژول تنظیمات محیط توسعه است . این ماژول شامل تنظیماتی میشود که در محیط توسعه محلی ( Local ) از آنها استفاده میکنیم . مانند ```DEBUG = True```  ، log level و یا فعال کردن ابزارهای توسعه مانند <i> django-debug-toolbar </i>

بعضی توسعه دهنده ها نام های دیگری مانند <i> dev.py </i> برای این ماژول درنظر میگیرند .

<i class="fa fa-chevron-left"></i> &nbsp;
<b>
staging.py
</b>

نسخه ی حالت نمایش ( Staging ) از اجرای نیمه خصوصی برنامه بر روی سرور اصلی ( Production server ) .
این مرحله ایست که مدیران و کاربران قبل از بارگزاری نسخه نهایی برنامه بر روی سرور ، با برنامه کار میکنند .

<i class="fa fa-chevron-left"></i> &nbsp;
<b>
test.py
</b>

این ماژول تنظیمات مربوط به مرحله تست برنامه را شامل میشه .
مثلا استفاده از ماژول ( test runner ) ، تنظیمات لاگ ( log settings ) و ...

<i class="fa fa-chevron-left"></i> &nbsp;
<b>
production.py
</b>

این ماژول تنظیمات سرور بهره برداری (Live production server) است ، یعنی همه تنظیمات مربوط به مرحله بهره برداری یا به اصطلاح ( Production ) در این ماژول نگهداری میشن . 

بعضی توسعه دهنده ها نام های دیگری مانند <i> prod.py </i> برای این ماژول درنظر میگیرند .

<blockquote class="grey lighten-3">
ممکن است نیاز باشد یک ماژول <i> ci.py </i> برای تنظیمات سرور داشته باشیم ، همچنین اگر پروژه مان کمی بزرگ باشد ممکن است نیاز به سرور های دیگری هم داشته باشیم که در این صورت باید در شرایط مختلف ، ماژول های متناسب بسازیم .
</blockquote>

<br>
خب حالا ببینیم که چطور باید از این تنظیمات متفاوت استفاده کنیم .

برای این کار باید از آپشن ```--settings``` در خط فرمان استفاده کنیم .

برای مثال اجرای مترجم پایتون با تنظیمات محلی ( local ) به این صورت خواهد بود :
{% highlight shell %}
python manage.py shell --settings=mysite.settings.local   # آدرس ماژول تنظیمات محلی
{% endhighlight %}

و یا اجرای وب سرور آزمایشی با تنظیمات staging :
{% highlight shell %}
python manage.py runserver --settings=mysite.settings.staging
{% endhighlight %}

<br><br>
<i class="fa fa-arrow-left"></i> &nbsp;
<b> یک مثال برای درک بهتر تنظیمات چندگانه </b>

خب همانطور که دیدیم ، ما به یک ماژول تنظیمات پیکربندی محلی نیاز داریم تا تنظیمات فاز توسعه خودمان را در آن تعریف کنیم . تنظیماتی مانند انتخاب بکند ایمیل ، تنظیمات دیتابیسِ مرحله توسعه ،  تنظیمات حالت ``` DEBUG ``` و همه تنظیماتی که در محیط توسعه برنامه به آن نیاز داریم . نمونه این تنظیمات میتواند چیزی شبیه به تکه کد زیر باشد :

{% highlight python %}

# settings/local.py

from .base import *

DEBUG = True

EMAIL_BACKEND = 'django.core.mail.backends.console.EmailBackend'

DATABASES = {
    'default': {
        'ENGINE': 'django.db.backends.sqlite3',
        'NAME': os.path.join(BASE_DIR, 'db.sqlite3'),
    }
}

INSTALLED_APPS += ("debug_toolbar", )

{% endhighlight%}

حالا وب سرور آزمایشی را با دستور زیر اجرا میکنیم :

{% highlight shell %}
python manage.py runserver --settings=mysite.settings.local
{% endhighlight %}

<blockquote class="grey lighten-3">
به هیچ عنوان از عبارات شرطی ، حلقه یا عبارات منطقی در ماژول تنظیمات پیکربندی استفاده نکنید . تنظیمات باید در ساده ترین شکل ممکن باشند .
</blockquote>

<br>
<i class="fa fa-arrow-left"></i> &nbsp;
<b>
تنظیمات پیکربندی محلیِ چندگانه
</b>

گاهی اوقات ما بر روی پروژه های بزرگی کار میکنیم که در این وضعیت ، توسعه دهندگان مختلف به تنظیمات پیکربندی محلی مختلف ( تنظیمات مخصوص به خود ) نیاز دارند و اشتراک یک ماژول <i>dev.py</i> راه حل مناسبی نخواهد بود .

در این وضعیت اگر ماژول های تنظیمات توسط ابزار کنترل نسخه ردیابی شوند و هر توسعه دهنده ، ماژول تنظیمات مخصوص به خود را داشته باشد مانند <i> dev_aref.py </i> و <i> dev_reza.py </i>
راه حل بهتری است تا اینکه توسعه دهنده های مختلف ، ماژول <i>local.py</i> یا <i>dev.py</i> را برای خود شخصی سازی کنند (بدون ردیابی توسط ابزار کنترل نسخه)

{% highlight python %}
# settings/dev_aref.py

from .local import *

# Set short cache timeout
CACHE_TIMEOUT = 30
{% endhighlight %}

این راه حل نه تنها از این لحاظ که ماژول تنظیمات ردیابی میشوند مناسب است ، بلکه شما میتوانید تنظیماتِ توسعه دهندگانِ همکارتان را مشاهده کنید و ایرادات یکدیگر را برطرف کنید . همچنین میشود از هماهنگ بودن همه ماژول های تنظیمات محلی مطمئن شد .

دایرکتوری تنظیمات برای همچین پروژه ای ، چیزی شبیه به مثال زیر خواهد شد :

{% highlight shell %}
settings/
    __init__.py
    base.py
    dev_aref.py
    dev_reza.py
    local.py
    staging.py
    test.py
    production.py
{% endhighlight %}






<br>
<br>
<br>
<i class="fa fa-book"></i> &nbsp; 
منابع
<br>

[Django documentation][django-docs]

[James Bennett volunteers as both a Django core developer and as its release manager.][james-bennett-site]







[python-module]: https://docs.python.org/3/tutorial/modules.html
[diff-wiki]: https://fa.wikipedia.org/wiki/Diff
[django-ref-settings]: https://docs.djangoproject.com/en/2.2/ref/settings/
[vcs-wiki]: https://fa.wikipedia.org/wiki/%DA%A9%D9%86%D8%AA%D8%B1%D9%84_%D9%86%D8%B3%D8%AE%D9%87
[git-tutorial]: https://git-scm.com/book/fa/v2
[public-key]: https://fa.wikipedia.org/wiki/%D8%B1%D9%85%D8%B2%D9%86%DA%AF%D8%A7%D8%B1%DB%8C_%DA%A9%D9%84%DB%8C%D8%AF_%D8%B9%D9%85%D9%88%D9%85%DB%8C
[django-signing]: https://docs.djangoproject.com/en/2.2/topics/signing/









[django-docs]: https://docs.djangoproject.com/en/2.2/
[james-bennett-site]: https://www.b-list.org/
